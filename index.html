<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>é£Ÿç‰©é€£é–ã‚²ãƒ¼ãƒ  - è‰ãƒ»ã‚·ã‚«ãƒ»ã‚ªã‚ªã‚«ãƒŸ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f4f6ff;
      --card: #ffffff;
      --accent: #4f8cff;
      --accent-soft: #e4edff;
      --ink: #203040;
      --danger: #ff5c7a;
      --grid-line: #d0d7f0;
      --grass: #c8f5a7;
      --grass-bare: #e9ffd8;
      --sea: #b5d8ff;
      --waste: #f3e1b5;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "M PLUS Rounded 1c", system-ui, sans-serif;
      background: radial-gradient(circle at top, #fdfbff 0, #f4f6ff 45%, #e9f0ff 100%);
      color: var(--ink);
    }

    header {
      padding: 10px 16px;
      background: #ffffffb0;
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #dde3ff;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.4em;
    }

    header h1 span.icon {
      font-size: 1.4em;
    }

    main {
      max-width: 1100px;
      margin: 12px auto 32px;
      padding: 0 12px;
      display: grid;
      grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      padding: 12px 14px;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 0.4em;
    }

    h2 span.small {
      font-size: 0.8em;
      color: #718096;
      font-weight: normal;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
      align-items: center;
      font-size: 0.85rem;
    }

    .controls-grid label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .controls-grid span.caption {
      font-size: 0.8rem;
      color: #718096;
    }

    input[type="number"] {
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #cbd5f5;
      font-size: 0.85rem;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px #c6d8ff;
    }

    .buttons-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3em;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    button.primary {
      background: var(--accent);
      color: #fff;
    }

    button.danger {
      background: var(--danger);
      color: #fff;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    #stats {
      font-size: 0.86rem;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      margin-top: 6px;
      padding: 6px 8px;
      background: #f5f7ff;
      border-radius: 8px;
    }

    #stats span.badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #d0d7f0;
      display: inline-flex;
      align-items: center;
      gap: 0.2em;
    }

    #mapWrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    #map {
      display: grid;
      gap: 1px;
      padding: 6px;
      background: var(--grid-line);
      border-radius: 10px;
      max-width: 100%;
      touch-action: none;
    }

    .cell {
      width: 26px;
      height: 26px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      user-select: none;
    }

    .cell.grass { background: var(--grass); }
    .cell.grass.bare { background: var(--grass-bare); }
    .cell.sea { background: var(--sea); }
    .cell.waste { background: var(--waste); }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
      font-size: 0.8rem;
      justify-content: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: inline-block;
    }

    .legend-box.grass { background: var(--grass); }
    .legend-box.sea { background: var(--sea); }
    .legend-box.waste { background: var(--waste); }

    #help {
      font-size: 0.82rem;
      color: #4a5568;
      line-height: 1.5;
    }

    #help ul {
      padding-left: 1.2em;
      margin: 0.4em 0 0;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><span class="icon">ğŸ¦ŒğŸº</span>é£Ÿç‰©é€£é–ã‚²ãƒ¼ãƒ  <span style="font-size:0.8rem;color:#718096;">è‰ â†’ ã‚·ã‚« â†’ ã‚ªã‚ªã‚«ãƒŸ</span></h1>
  </header>

  <main>
    <!-- å·¦å´ï¼šè¨­å®šãƒ‘ãƒãƒ« -->
    <section class="card">
      <h2>â‘  è¨­å®š <span class="small">ï¼ˆæ•°å­—ã‚’å¤‰ãˆã¦éŠã¹ã¾ã™ï¼‰</span></h2>
      <div class="controls-grid">
        <label>
          ãƒãƒƒãƒ—ã‚µã‚¤ã‚º
          <input id="sizeInput" type="number" min="5" max="40" value="15">
          <span class="caption">5ã€œ40ï¼ˆæ­£æ–¹å½¢ï¼šä¾‹ 15Ã—15ï¼‰</span>
        </label>

        <label>
          è‰ã®å†ç”Ÿã‚¿ãƒ¼ãƒ³
          <input id="grassRegrowInput" type="number" min="1" max="50" value="6">
          <span class="caption">é£Ÿã¹ã‚‰ã‚Œã¦ã‹ã‚‰å…ƒã«æˆ»ã‚‹ã¾ã§</span>
        </label>

        <label>
          ã‚·ã‚«ã®å¯¿å‘½ï¼ˆã‚¿ãƒ¼ãƒ³ï¼‰
          <input id="deerLifeInput" type="number" min="1" max="200" value="35">
          <span class="caption">ã“ã‚Œã‚’éãã‚‹ã¨è€è¡°ã§æ­»äº¡</span>
        </label>

        <label>
          ã‚·ã‚«ã®ç©ºè…¹é™ç•Œ
          <input id="deerStarveInput" type="number" min="1" max="50" value="7">
          <span class="caption">è‰ã‚’é£Ÿã¹ãšã«ã„ã‚‰ã‚Œã‚‹ã‚¿ãƒ¼ãƒ³</span>
        </label>

        <label>
          ã‚ªã‚ªã‚«ãƒŸã®å¯¿å‘½
          <input id="wolfLifeInput" type="number" min="1" max="200" value="45">
          <span class="caption">ã“ã‚Œã‚’éãã‚‹ã¨è€è¡°ã§æ­»äº¡</span>
        </label>

        <label>
          ã‚ªã‚ªã‚«ãƒŸã®ç©ºè…¹é™ç•Œ
          <input id="wolfStarveInput" type="number" min="1" max="50" value="9">
          <span class="caption">ã‚·ã‚«ã‚’é£Ÿã¹ãšã«ã„ã‚‰ã‚Œã‚‹ã‚¿ãƒ¼ãƒ³</span>
        </label>

        <label>
          åˆæœŸã‚·ã‚«æ•°
          <input id="initialDeerInput" type="number" min="0" value="12">
          <span class="caption">æœ€åˆã«å‡ºç¾ã™ã‚‹ã‚·ã‚«ã®æ•°</span>
        </label>

        <label>
          åˆæœŸã‚ªã‚ªã‚«ãƒŸæ•°
          <input id="initialWolfInput" type="number" min="0" value="5">
          <span class="caption">æœ€åˆã«å‡ºç¾ã™ã‚‹ã‚ªã‚ªã‚«ãƒŸã®æ•°</span>
        </label>
      </div>

      <div class="buttons-row">
        <button id="randomMapBtn" type="button">
          ğŸ² ãƒ©ãƒ³ãƒ€ãƒ åœ°å½¢ã‚’ã¤ãã‚‹
        </button>
        <button id="resetBtn" type="button">
          ğŸ” ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>

      <h2 style="margin-top:12px;">â‘¡ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
      <div class="buttons-row">
        <button id="startStopBtn" class="primary" type="button">
          â–¶ é–‹å§‹
        </button>
        <button id="stepBtn" type="button">
          â© 1ã‚¿ãƒ¼ãƒ³é€²ã‚ã‚‹
        </button>
      </div>

      <div id="stats">
        <span class="badge">ã‚¿ãƒ¼ãƒ³: <span id="turnSpan">0</span></span>
        <span class="badge">ğŸŒ± è‰ã‚ã‚Šãƒã‚¹: <span id="grassCountSpan">0</span></span>
        <span class="badge">ğŸ¦Œ ã‚·ã‚«: <span id="deerCountSpan">0</span></span>
        <span class="badge">ğŸº ã‚ªã‚ªã‚«ãƒŸ: <span id="wolfCountSpan">0</span></span>
      </div>

      <div id="help" style="margin-top:10px;">
        <b>ãƒ«ãƒ¼ãƒ«ï¼ˆã–ã£ãã‚Šï¼‰</b>
        <ul>
          <li>è‰ã¯ã€Œè‰åœ°ã€ã®ä¸Šã«ç”Ÿãˆã€é£Ÿã¹ã‚‰ã‚Œã‚‹ã¨æ¶ˆãˆã¾ã™ï¼ˆæŒ‡å®šã‚¿ãƒ¼ãƒ³å¾Œã«å†ç”Ÿï¼‰ã€‚</li>
          <li>ã‚·ã‚«ã¯ä¸Šä¸‹å·¦å³ã«ç§»å‹•ã—ã€è‰ã‚’é£Ÿã¹ã¦ç”Ÿãå»¶ã³ã¾ã™ã€‚é£Ÿã¹ãªã„ã¨ã€Œç©ºè…¹ã‚¿ãƒ¼ãƒ³ã€ã‚’è¶…ãˆã¦æ­»äº¡ã€‚</li>
          <li>ã‚ªã‚ªã‚«ãƒŸã¯ã‚·ã‚«ã‚’è¿½ã„ã‹ã‘ã¦é£Ÿã¹ã¾ã™ã€‚ã‚·ã‚«ãŒã„ãªã„ã¨ãŠè…¹ãŒã™ã„ã¦ã€Œç©ºè…¹ã‚¿ãƒ¼ãƒ³ã€ã‚’è¶…ãˆã¦æ­»äº¡ã€‚</li>
          <li>ã‚·ã‚«ãƒ»ã‚ªã‚ªã‚«ãƒŸã¯ã€ååˆ†ç”Ÿãã¦ã„ã‚‹ã¨ãã«å°‘ã—ã®ç¢ºç‡ã§å­ã©ã‚‚ã‚’ç”£ã¿ã¾ã™ã€‚</li>
          <li>æµ·ã«ã¯ç”Ÿãç‰©ã¯å…¥ã‚Œã¾ã›ã‚“ã€‚è’åœ°ã¯é€šã‚Œã‚‹ã‘ã‚Œã©è‰ã¯ç”Ÿãˆã¾ã›ã‚“ã€‚</li>
        </ul>
      </div>
    </section>

    <!-- å³å´ï¼šãƒãƒƒãƒ—è¡¨ç¤º -->
    <section class="card" id="mapWrapper">
      <h2>â‘¢ ãƒãƒƒãƒ— <span class="small">ï¼ˆè‰åŸã«åºƒãŒã‚‹ç”Ÿæ…‹ç³»ï¼‰</span></h2>
      <div id="map"></div>
      <div class="legend">
        <div class="legend-item">
          <span class="legend-box grass"></span> è‰åœ°ï¼ˆğŸŒ±ãŒç”Ÿãˆã‚‹ï¼‰
        </div>
        <div class="legend-item">
          <span class="legend-box sea"></span> æµ·ï¼ˆå…¥ã‚Œãªã„ï¼‰
        </div>
        <div class="legend-item">
          <span class="legend-box waste"></span> è’åœ°ï¼ˆè‰ãªã—ï¼‰
        </div>
        <div class="legend-item">
          ğŸ¦Œ ã‚·ã‚«ï¼ˆè‰ã‚’é£Ÿã¹ã‚‹ï¼‰
        </div>
        <div class="legend-item">
          ğŸº ã‚ªã‚ªã‚«ãƒŸï¼ˆã‚·ã‚«ã‚’é£Ÿã¹ã‚‹ï¼‰
        </div>
      </div>
    </section>
  </main>

  <script>
    // ====== ãƒ‡ãƒ¼ã‚¿æ§‹é€  ======
    let size = 15;               // ãƒãƒƒãƒ—ã®ä¸€è¾º
    let cells = [];              // 2æ¬¡å…ƒé…åˆ— [y][x]
    let deerList = [];           // ã‚·ã‚«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—
    let wolfList = [];           // ã‚ªã‚ªã‚«ãƒŸã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—
    let turn = 0;
    let timerId = null;

    const mapEl = document.getElementById('map');
    const turnSpan = document.getElementById('turnSpan');
    const grassCountSpan = document.getElementById('grassCountSpan');
    const deerCountSpan = document.getElementById('deerCountSpan');
    const wolfCountSpan = document.getElementById('wolfCountSpan');
    const startStopBtn = document.getElementById('startStopBtn');
    const stepBtn = document.getElementById('stepBtn');

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function getInputs() {
      size = clamp(parseInt(document.getElementById('sizeInput').value || '15', 10), 5, 40);
      const grassRegrow = clamp(parseInt(document.getElementById('grassRegrowInput').value || '6', 10), 1, 50);
      const deerLife = clamp(parseInt(document.getElementById('deerLifeInput').value || '35', 10), 1, 200);
      const deerStarve = clamp(parseInt(document.getElementById('deerStarveInput').value || '7', 10), 1, 50);
      const wolfLife = clamp(parseInt(document.getElementById('wolfLifeInput').value || '45', 10), 1, 200);
      const wolfStarve = clamp(parseInt(document.getElementById('wolfStarveInput').value || '9', 10), 1, 50);
      const initialDeer = Math.max(0, parseInt(document.getElementById('initialDeerInput').value || '12', 10));
      const initialWolf = Math.max(0, parseInt(document.getElementById('initialWolfInput').value || '5', 10));

      return {
        grassRegrow,
        deerLife,
        deerStarve,
        wolfLife,
        wolfStarve,
        initialDeer,
        initialWolf
      };
    }

    function clamp(v, min, max) {
      return Math.min(max, Math.max(min, v));
    }

    function neighbors(x, y) {
      const list = [];
      if (x > 0) list.push({ x: x - 1, y });
      if (x < size - 1) list.push({ x: x + 1, y });
      if (y > 0) list.push({ x, y: y - 1 });
      if (y < size - 1) list.push({ x, y: y + 1 });
      return list;
    }

    function randomChoice(arr) {
      if (!arr.length) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    // ====== ãƒãƒƒãƒ—ç”Ÿæˆ ======
    function createRandomMap() {
      const { grassRegrow } = getInputs();
      cells = [];
      mapEl.innerHTML = '';
      mapEl.style.gridTemplateColumns = `repeat(${size}, 26px)`;

      for (let y = 0; y < size; y++) {
        const row = [];
        for (let x = 0; x < size; x++) {
          // åœ°å½¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®šï¼ˆè‰å¤šã‚ï¼‰
          const r = Math.random();
          let terrain;
          if (r < 0.65) terrain = 'grass';
          else if (r < 0.8) terrain = 'waste';
          else terrain = 'sea';

          const div = document.createElement('div');
          div.className = 'cell';
          div.dataset.x = x;
          div.dataset.y = y;
          mapEl.appendChild(div);

          const cell = {
            x, y,
            terrain,
            hasGrass: terrain === 'grass',
            grassTimer: 0,
            grassRegrow,
            deer: null,
            wolf: null,
            el: div
          };
          row.push(cell);
        }
        cells.push(row);
      }
      renderAllCells();
    }

    function clearAnimals() {
      deerList = [];
      wolfList = [];
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          cells[y][x].deer = null;
          cells[y][x].wolf = null;
        }
      }
    }

    function placeInitialAnimals() {
      clearAnimals();
      const { initialDeer, initialWolf } = getInputs();

      // ã‚·ã‚«ã‚’é…ç½®ï¼ˆè‰åœ°ã‹è’åœ°ã®ã¿ï¼‰
      for (let i = 0; i < initialDeer; i++) {
        const pos = findRandomEmptyLandCell();
        if (!pos) break;
        const deer = {
          x: pos.x,
          y: pos.y,
          age: 0,
          hunger: 0
        };
        deerList.push(deer);
        cells[pos.y][pos.x].deer = deer;
      }

      // ã‚ªã‚ªã‚«ãƒŸã‚’é…ç½®ï¼ˆè‰åœ°ã‹è’åœ°ã®ã¿ï¼‰
      for (let i = 0; i < initialWolf; i++) {
        const pos = findRandomEmptyLandCell();
        if (!pos) break;
        const wolf = {
          x: pos.x,
          y: pos.y,
          age: 0,
          hunger: 0
        };
        wolfList.push(wolf);
        cells[pos.y][pos.x].wolf = wolf;
      }
    }

    function findRandomEmptyLandCell() {
      const candidates = [];
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const c = cells[y][x];
          if (c.terrain !== 'sea' && !c.deer && !c.wolf) {
            candidates.push({ x, y });
          }
        }
      }
      return randomChoice(candidates);
    }

    // ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ======
    function renderAllCells() {
      let grassCount = 0;
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = cells[y][x];
          const el = cell.el;
          el.textContent = '';
          el.className = 'cell';
          el.classList.add(cell.terrain);
          if (cell.terrain === 'grass' && !cell.hasGrass) {
            el.classList.add('bare');
          }
          if (cell.deer) {
            el.textContent = 'ğŸ¦Œ';
          }
          if (cell.wolf) {
            el.textContent = 'ğŸº';
          }
          if (cell.terrain === 'grass' && cell.hasGrass) {
            grassCount++;
          }
        }
      }
      grassCountSpan.textContent = grassCount;
      deerCountSpan.textContent = deerList.length;
      wolfCountSpan.textContent = wolfList.length;
      turnSpan.textContent = turn;
    }

    // ====== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1ã‚¿ãƒ¼ãƒ³ ======
    function step() {
      if (!cells.length) return;
      const {
        grassRegrow,
        deerLife,
        deerStarve,
        wolfLife,
        wolfStarve
      } = getInputs();

      turn++;

      // è‰ã®å†ç”Ÿ
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = cells[y][x];
          cell.grassRegrow = grassRegrow;
          if (cell.terrain === 'grass' && !cell.hasGrass) {
            cell.grassTimer--;
            if (cell.grassTimer <= 0) {
              cell.hasGrass = true;
              cell.grassTimer = 0;
            }
          }
        }
      }

      // --- ã‚·ã‚«ã®è¡Œå‹• ---
      const oldDeer = [...deerList];
      const newDeer = [];

      for (const deer of oldDeer) {
        let { x, y, age, hunger } = deer;
        age++;
        hunger++;

        // ç§»å‹•å€™è£œï¼ˆæµ·ä»¥å¤–ã®ã¿ï¼‰
        const neigh = neighbors(x, y).filter(p => cells[p.y][p.x].terrain !== 'sea');
        let dest = randomChoice(neigh) || { x, y };

        // ã™ã§ã«ã‚·ã‚«ãŒã„ã‚‹ãƒã‚¹ã¯é¿ã‘ã‚‹ï¼ˆä»Šã‚¿ãƒ¼ãƒ³ã®æ–°ã‚·ã‚«ã‚‚å«ã‚ã¦ï¼‰
        if (cells[dest.y][dest.x].deer) {
          dest = { x, y }; // å‹•ã‹ãªã„
        }

        // å…ƒã®ã‚»ãƒ«ã‹ã‚‰ã‚·ã‚«ã‚’æ¶ˆã™
        cells[y][x].deer = null;

        // æ–°ã—ã„ã‚»ãƒ«ã«ç§»å‹•
        x = dest.x;
        y = dest.y;
        const targetCell = cells[y][x];

        // è‰ã‚’é£Ÿã¹ã‚‹
        if (targetCell.terrain === 'grass' && targetCell.hasGrass) {
          targetCell.hasGrass = false;
          targetCell.grassTimer = grassRegrow;
          hunger = 0; // ãŠè…¹ã„ã£ã±ã„
        }

        // ç©ºè…¹ or è€è¡°ã§æ­»äº¡
        if (hunger > deerStarve || age > deerLife) {
          continue;
        }

        const updatedDeer = { x, y, age, hunger };
        newDeer.push(updatedDeer);
        targetCell.deer = updatedDeer;

        // ç¹æ®–ï¼ˆå°‘ã—ã ã‘ç¢ºç‡ã‚’æŒãŸã›ã‚‹ï¼‰
        if (age > Math.floor(deerLife / 3) && Math.random() < 0.12) {
          const emptyAround = neighbors(x, y).filter(p => {
            const c = cells[p.y][p.x];
            return c.terrain !== 'sea' && !c.deer && !c.wolf;
          });
          const birthPos = randomChoice(emptyAround);
          if (birthPos) {
            const baby = {
              x: birthPos.x,
              y: birthPos.y,
              age: 0,
              hunger: 0
            };
            newDeer.push(baby);
            cells[birthPos.y][birthPos.x].deer = baby;
          }
        }
      }
      deerList = newDeer;

      // --- ã‚ªã‚ªã‚«ãƒŸã®è¡Œå‹• ---
      const oldWolf = [...wolfList];
      const newWolf = [];

      for (const wolf of oldWolf) {
        let { x, y, age, hunger } = wolf;
        age++;
        hunger++;

        // ã¾ãšè¿‘ãã«ã‚·ã‚«ãŒã„ãªã„ã‹æ¢ã™ï¼ˆ1ãƒã‚¹ä»¥å†…ï¼‰
        const neigh = neighbors(x, y);
        const deerAround = neigh.filter(p => cells[p.y][p.x].deer);

        let dest;
        if (deerAround.length) {
          // ã‚·ã‚«ãŒã„ã‚‹ãƒã‚¹ã‚’å„ªå…ˆ
          dest = randomChoice(deerAround);
        } else {
          // æ™®é€šã«ç§»å‹•ï¼ˆæµ·ä»¥å¤–ï¼‰
          const movable = neigh.filter(p => cells[p.y][p.x].terrain !== 'sea');
          dest = randomChoice(movable) || { x, y };
        }

        cells[y][x].wolf = null; // å…ƒã®ãƒã‚¹ã‹ã‚‰æ¶ˆã™
        x = dest.x;
        y = dest.y;
        const targetCell = cells[y][x];

        // ã‚·ã‚«ãŒã„ã‚Œã°æ•é£Ÿ
        if (targetCell.deer) {
          // deerList ã‹ã‚‰ã‚‚å‰Šé™¤
          const victim = targetCell.deer;
          deerList = deerList.filter(d => d !== victim);
          targetCell.deer = null;
          hunger = 0; // ãŠè…¹ã„ã£ã±ã„
        }

        // ç©ºè…¹ or è€è¡°ã§æ­»äº¡
        if (hunger > wolfStarve || age > wolfLife) {
          continue;
        }

        const updatedWolf = { x, y, age, hunger };
        newWolf.push(updatedWolf);
        targetCell.wolf = updatedWolf;

        // ç¹æ®–ï¼ˆå°‘ã—ã ã‘ç¢ºç‡ã‚’æŒãŸã›ã‚‹ï¼‰
        if (age > Math.floor(wolfLife / 3) && Math.random() < 0.08) {
          const emptyAround = neighbors(x, y).filter(p => {
            const c = cells[p.y][p.x];
            return c.terrain !== 'sea' && !c.wolf;
          });
          const birthPos = randomChoice(emptyAround);
          if (birthPos) {
            const baby = {
              x: birthPos.x,
              y: birthPos.y,
              age: 0,
              hunger: 0
            };
            newWolf.push(baby);
            cells[birthPos.y][birthPos.x].wolf = baby;
          }
        }
      }
      wolfList = newWolf;

      renderAllCells();
    }

    // ====== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ======
    function resetSimulation(newMap = false) {
      const inputs = getInputs();
      if (newMap || !cells.length || size !== cells.length) {
        createRandomMap();
      }
      turn = 0;
      placeInitialAnimals();
      renderAllCells();
    }

    function startSimulation() {
      if (timerId) return;
      timerId = setInterval(() => {
        step();
        if (deerList.length === 0 && wolfList.length === 0) {
          // å…¨æ»…ã—ãŸã‚‰æ­¢ã‚ã‚‹
          stopSimulation();
        }
      }, 400); // 0.4ç§’ã”ã¨ã«1ã‚¿ãƒ¼ãƒ³
      startStopBtn.textContent = 'â¸ ä¸€æ™‚åœæ­¢';
      startStopBtn.classList.add('danger');
      startStopBtn.classList.remove('primary');
    }

    function stopSimulation() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      startStopBtn.textContent = 'â–¶ å†é–‹';
      startStopBtn.classList.remove('danger');
      startStopBtn.classList.add('primary');
    }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ======
    document.getElementById('randomMapBtn').addEventListener('click', () => {
      stopSimulation();
      resetSimulation(true);
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      stopSimulation();
      resetSimulation(false);
    });

    startStopBtn.addEventListener('click', () => {
      if (timerId) {
        stopSimulation();
      } else {
        startSimulation();
      }
    });

    stepBtn.addEventListener('click', () => {
      if (!cells.length) return;
      stopSimulation();
      step();
      renderAllCells();
    });

    // åˆæœŸèµ·å‹•
    createRandomMap();
    placeInitialAnimals();
    renderAllCells();
  </script>
</body>
</html>
